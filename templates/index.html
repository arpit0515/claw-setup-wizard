<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>claw-setup - PicoClaw Setup Wizard</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #22263a;
    --border: #2e3350;
    --accent: #6c63ff;
    --accent2: #00d4aa;
    --danger: #ff4f4f;
    --warning: #ffb547;
    --text: #e8eaf6;
    --text2: #8b90b0;
    --success: #00d4aa;
    --radius: 12px;
    --header-h: 56px;
    --bottom-nav-h: 64px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 15px;
    min-height: 100vh;
    min-height: 100dvh;
    overscroll-behavior: none;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    height: var(--header-h);
    padding: 0 16px;
    padding-top: env(safe-area-inset-top);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface);
    backdrop-filter: blur(12px);
  }
  header .logo { font-size: 20px; }
  header h1 { font-size: 17px; font-weight: 700; }
  header .logo-btn {
    display: flex; align-items: center; gap: 10px;
    cursor: pointer;
    padding: 4px 8px 4px 0;
    border-radius: 8px;
    transition: opacity 0.15s;
    -webkit-user-select: none; user-select: none;
  }
  header .logo-btn:hover { opacity: 0.75; }
  header .logo-btn:active { opacity: 0.5; }
  header .header-badge {
    margin-left: auto;
    font-size: 11px;
    color: var(--text2);
    background: var(--surface2);
    padding: 3px 8px;
    border-radius: 20px;
    border: 1px solid var(--border);
    white-space: nowrap;
  }

  .progress-bar {
    position: fixed;
    top: var(--header-h);
    left: 0; right: 0;
    height: 3px;
    background: var(--border);
    z-index: 99;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    transition: width 0.4s ease;
  }

  .layout {
    display: flex;
    min-height: 100vh;
    min-height: 100dvh;
    padding-top: calc(var(--header-h) + 3px);
  }

  .sidebar {
    width: 240px;
    flex-shrink: 0;
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 20px 0;
    position: sticky;
    top: calc(var(--header-h) + 3px);
    height: calc(100vh - var(--header-h) - 3px);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  .sidebar-title {
    padding: 0 18px 12px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text2);
  }
  .step-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 18px;
    cursor: pointer;
    transition: background 0.15s;
    border-left: 3px solid transparent;
    border-right: none;
  }
  .step-item:hover { background: var(--surface2); }
  .step-item.active { background: var(--surface2); border-left-color: var(--accent); }
  .step-icon {
    width: 26px; height: 26px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700;
    background: var(--surface2);
    border: 2px solid var(--border);
    flex-shrink: 0;
    transition: all 0.2s;
  }
  .step-item.done .step-icon { background: var(--success); border-color: var(--success); color: #000; }
  .step-item.active .step-icon { border-color: var(--accent); color: var(--accent); }
  .step-item.error .step-icon { border-color: var(--danger); color: var(--danger); }
  .step-label { font-size: 13px; font-weight: 500; }
  .step-sub { font-size: 11px; color: var(--text2); margin-top: 1px; }

  .bottom-nav {
    display: none;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 100;
    height: var(--bottom-nav-h);
    padding-bottom: env(safe-area-inset-bottom);
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: none;
    align-items: stretch;
  }
  .bottom-nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    cursor: pointer;
    padding: 6px 4px;
    transition: background 0.15s;
    border-top: 2px solid transparent;
    position: relative;
  }
  .bottom-nav-item:active { background: var(--surface2); }
  .bottom-nav-item.active { border-top-color: var(--accent); }
  .bottom-nav-item.done .bnav-icon { color: var(--success); }
  .bottom-nav-item.error .bnav-icon { color: var(--danger); }
  .bnav-icon {
    font-size: 11px;
    font-weight: 700;
    width: 22px; height: 22px;
    border-radius: 50%;
    background: var(--surface2);
    border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .bottom-nav-item.done .bnav-icon { background: var(--success); border-color: var(--success); color: #000; }
  .bottom-nav-item.active .bnav-icon { border-color: var(--accent); color: var(--accent); }
  .bottom-nav-item.error .bnav-icon { border-color: var(--danger); color: var(--danger); }
  .bnav-label { font-size: 9px; color: var(--text2); font-weight: 500; text-align: center; line-height: 1.2; }
  .bottom-nav-item.active .bnav-label { color: var(--accent); }

  .main {
    flex: 1;
    min-width: 0;
    padding: 24px 20px;
    max-width: 720px;
    width: 100%;
  }

  .section { display: none; }
  .section.active { display: block; }

  h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
  .subtitle { color: var(--text2); font-size: 13px; margin-bottom: 20px; line-height: 1.5; }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 14px;
  }
  .card-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text2);
    margin-bottom: 12px;
  }

  .status-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 11px 0;
    border-bottom: 1px solid var(--border);
  }
  .status-row:last-child { border-bottom: none; }
  .status-left {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
    flex: 1;
  }
  .status-label { font-size: 13px; font-weight: 600; }
  .status-detail {
    font-size: 11px;
    color: var(--text2);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }
  .badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 2px 8px; border-radius: 20px;
    font-size: 11px; font-weight: 600;
    white-space: nowrap; flex-shrink: 0;
  }
  .badge.ok { background: rgba(0,212,170,0.15); color: var(--success); }
  .badge.fail { background: rgba(255,79,79,0.15); color: var(--danger); }
  .badge.warn { background: rgba(255,181,71,0.15); color: var(--warning); }
  .badge.pending { background: var(--surface2); color: var(--text2); }

  .form-group { margin-bottom: 14px; }
  label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--text2);
  }
  input[type=text], input[type=password], textarea, select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    color: var(--text);
    font-size: 15px;
    outline: none;
    transition: border-color 0.15s;
    font-family: inherit;
    -webkit-appearance: none;
    appearance: none;
  }
  input:focus, textarea:focus, select:focus { border-color: var(--accent); }
  select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='none'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238b90b0' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 32px;
  }
  textarea { resize: vertical; min-height: 72px; line-height: 1.5; }
  .hint { font-size: 11px; color: var(--text2); margin-top: 4px; }

  .provider-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 16px;
  }
  .provider-card {
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 12px 10px;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
    -webkit-user-select: none;
    user-select: none;
  }
  .provider-card:active { transform: scale(0.97); }
  .provider-card:hover { border-color: var(--accent); }
  .provider-card.selected { border-color: var(--accent); background: rgba(108,99,255,0.1); }
  .provider-name { font-weight: 700; font-size: 13px; margin-bottom: 2px; }
  .provider-hint { font-size: 10px; color: var(--text2); }

  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    white-space: nowrap;
    -webkit-user-select: none;
    user-select: none;
    touch-action: manipulation;
  }
  .btn:active { transform: scale(0.97); }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #7b73ff; }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); }
  .btn-success { background: var(--success); color: #000; }
  .btn-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 16px;
    flex-wrap: wrap;
  }

  .alert {
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.5;
    margin: 10px 0;
    display: none;
  }
  .alert.visible { display: block; }
  .alert.success { background: rgba(0,212,170,0.1); border: 1px solid var(--success); color: var(--success); }
  .alert.error { background: rgba(255,79,79,0.1); border: 1px solid var(--danger); color: var(--danger); }
  .alert.info { background: rgba(108,99,255,0.1); border: 1px solid var(--accent); color: #a9a3ff; }

  .guide-step {
    display: flex;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .guide-step:last-child { border-bottom: none; }
  .guide-num {
    width: 24px; height: 24px;
    background: var(--accent);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .guide-text { font-size: 14px; line-height: 1.6; }
  .guide-text code {
    background: var(--surface2);
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 12px;
    color: var(--accent2);
    word-break: break-all;
  }
  .guide-text a { color: var(--accent2); }

  #soul-preview {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    font-size: 12px;
    line-height: 1.7;
    white-space: pre-wrap;
    font-family: 'SF Mono', 'Fira Code', monospace;
    max-height: 320px;
    overflow-y: auto;
    display: none;
    -webkit-overflow-scrolling: touch;
  }

  .final-item {
    display: flex; align-items: center; gap: 10px;
    padding: 11px 0;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
  }
  .final-item:last-child { border-bottom: none; }
  .check { font-size: 16px; }

  .spinner {
    display: inline-block;
    width: 14px; height: 14px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    flex-shrink: 0;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  #install-picoclaw-section { display: none; }

  .model-load-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 8px;
    flex-wrap: wrap;
  }
  .model-load-row label {
    display: flex; align-items: center; gap: 5px;
    font-size: 12px; color: var(--text2); margin: 0;
    cursor: pointer;
  }

  /* key-status hint shown when using saved key */
  .key-status {
    font-size: 11px;
    color: var(--accent2);
    margin-top: 4px;
    display: none;
  }
  .key-status.visible { display: block; }

  .cmd-block {
    background: var(--surface2);
    border-radius: 8px;
    padding: 12px 14px;
    text-align: left;
    font-size: 12px;
    margin-bottom: 14px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  .cmd-block .cmd-hint { color: var(--text2); margin-bottom: 8px; font-size: 12px; }
  .cmd-block code {
    display: block;
    color: var(--accent2);
    margin-bottom: 4px;
    word-break: break-all;
  }

  @media (max-width: 640px) {
    .sidebar { display: none; }
    .bottom-nav { display: flex; }
    .main {
      padding: 16px 14px;
      padding-bottom: calc(var(--bottom-nav-h) + env(safe-area-inset-bottom) + 16px);
    }
    h2 { font-size: 18px; }
    .subtitle { font-size: 12px; margin-bottom: 16px; }
    .provider-grid { gap: 6px; }
    .provider-card { padding: 10px 8px; }
    .provider-name { font-size: 12px; }
    .btn { font-size: 13px; padding: 9px 14px; }
    .btn-row { gap: 6px; }
    .status-value { max-width: 90px; }
  }

  @media (min-width: 641px) and (max-width: 900px) {
    .sidebar { width: 200px; }
    .step-sub { display: none; }
    .main { padding: 20px 18px; }
  }

  @media (min-width: 901px) {
    .main { padding: 28px 28px; }
  }

  @media (max-width: 360px) {
    .provider-grid { grid-template-columns: 1fr; }
    .btn { width: 100%; justify-content: center; }
    .btn-row { flex-direction: column; align-items: stretch; }
  }

  /* ‚îÄ‚îÄ Network bar (below header) ‚îÄ‚îÄ */
  .net-bar {
    position: fixed;
    top: var(--header-h);
    left: 0; right: 0;
    z-index: 98;
    background: rgba(15,17,23,0.95);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 5px 16px;
    font-size: 12px;
    color: var(--text2);
    backdrop-filter: blur(8px);
  }
  .net-bar .net-url {
    font-family: 'SF Mono','Fira Code',monospace;
    color: var(--accent2);
    font-weight: 600;
    font-size: 13px;
    letter-spacing: 0.02em;
  }
  .net-bar .net-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--success);
    box-shadow: 0 0 6px var(--success);
    flex-shrink: 0;
  }
  .net-bar .net-copy {
    background: none;
    border: 1px solid var(--border);
    color: var(--text2);
    border-radius: 5px;
    padding: 1px 8px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .net-bar .net-copy:hover { border-color: var(--accent2); color: var(--accent2); }
  .net-bar .net-qr-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text2);
    border-radius: 5px;
    padding: 1px 8px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .net-bar .net-qr-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* layout offset for net-bar */
  .progress-bar { top: calc(var(--header-h) + 28px) !important; }
  .layout { padding-top: calc(var(--header-h) + 28px + 3px) !important; }
  .sidebar { top: calc(var(--header-h) + 28px + 3px) !important; height: calc(100vh - var(--header-h) - 28px - 3px) !important; }

  /* ‚îÄ‚îÄ QR Modal ‚îÄ‚îÄ */
  .qr-modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 200;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(6px);
    align-items: center;
    justify-content: center;
  }
  .qr-modal-overlay.open { display: flex; }
  .qr-modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px 24px 20px;
    text-align: center;
    max-width: 280px;
    width: 90%;
    position: relative;
  }
  .qr-modal h3 { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
  .qr-modal p { font-size: 12px; color: var(--text2); margin-bottom: 16px; }
  #qr-canvas { border-radius: 8px; }
  .qr-modal .qr-url {
    margin-top: 12px;
    font-family: 'SF Mono','Fira Code',monospace;
    font-size: 13px;
    color: var(--accent2);
    word-break: break-all;
  }
  .qr-modal .qr-close {
    position: absolute;
    top: 10px; right: 12px;
    background: none; border: none;
    color: var(--text2); font-size: 18px;
    cursor: pointer; line-height: 1;
    padding: 4px;
  }
  .qr-modal .qr-close:hover { color: var(--text); }

  /* ‚îÄ‚îÄ Action grid (replaces btn-row for quick actions) ‚îÄ‚îÄ */
  .action-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 4px;
  }
  .action-tile {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 8px 12px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 7px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    text-align: center;
    -webkit-user-select: none;
    user-select: none;
    touch-action: manipulation;
  }
  .action-tile:active { transform: scale(0.96); }
  .action-tile:hover { border-color: var(--accent); background: rgba(108,99,255,0.08); }
  .action-tile.danger:hover { border-color: var(--danger); background: rgba(255,79,79,0.08); }
  .action-tile .tile-icon { font-size: 22px; line-height: 1; }
  .action-tile .tile-label { font-size: 11px; font-weight: 600; color: var(--text2); }
  .action-tile.loading { opacity: 0.6; pointer-events: none; }

  @media (max-width: 640px) {
    .net-bar { font-size: 11px; gap: 7px; }
    .net-bar .net-url { font-size: 12px; }
    /* on mobile bump the layout down by net-bar height */
    .layout { padding-bottom: calc(var(--bottom-nav-h) + env(safe-area-inset-bottom) + 16px); }
    .main { padding-bottom: calc(var(--bottom-nav-h) + env(safe-area-inset-bottom) + 16px) !important; }
    .action-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .action-tile { padding: 12px 4px 10px; }
    .action-tile .tile-icon { font-size: 18px; }
    .action-tile .tile-label { font-size: 10px; }
  }
</style>
</head>
<body>


<!-- Network Bar -->
<div class="net-bar" id="net-bar" style="display:none">
  <div class="net-dot"></div>
  <span>Open</span>
  <span class="net-url" id="net-url-text">loading...</span>
  <button class="net-copy" onclick="copyNetUrl()" id="net-copy-btn">Copy</button>
  <button class="net-qr-btn" onclick="openQR()">QR</button>
</div>

<!-- QR Modal -->
<div class="qr-modal-overlay" id="qr-overlay" onclick="closeQRIfOutside(event)">
  <div class="qr-modal">
    <button class="qr-close" onclick="closeQR()">‚úï</button>
    <h3>Scan to Open</h3>
    <p>Point your phone camera at this code</p>
    <div id="qr-container" style="width:200px;height:200px;margin:0 auto;background:var(--surface2);border-radius:8px;display:flex;align-items:center;justify-content:center;">
      <div class="spinner"></div>
    </div>
    <div class="qr-url" id="qr-url-label"></div>
  </div>
</div>

<header>
  <div class="logo-btn" onclick="goTo(0)" title="Back to System Check">
    <div class="logo">ü¶ê</div>
    <h1>claw-setup</h1>
  </div>
  <span class="header-badge">PicoClaw Wizard</span>
</header>

<div class="progress-bar"><div class="progress-fill" id="progress" style="width:10%"></div></div>

<div class="layout">

  <!-- Desktop Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-title">Setup Steps</div>
    <div class="step-item active" id="nav-0" onclick="goTo(0)">
      <div class="step-icon" id="icon-0">1</div>
      <div><div class="step-label">System Check</div><div class="step-sub">Verify installation</div></div>
    </div>
    <div class="step-item" id="nav-1" onclick="goTo(1)">
      <div class="step-icon" id="icon-1">2</div>
      <div><div class="step-label">LLM Provider</div><div class="step-sub">Connect your AI</div></div>
    </div>
    <div class="step-item" id="nav-2" onclick="goTo(2)">
      <div class="step-icon" id="icon-2">3</div>
      <div><div class="step-label">Telegram</div><div class="step-sub">Your chat channel</div></div>
    </div>
    <div class="step-item" id="nav-3" onclick="goTo(3)">
      <div class="step-icon" id="icon-3">4</div>
      <div><div class="step-label">Your Twin</div><div class="step-sub">Build your SOUL.md</div></div>
    </div>
    <div class="step-item" id="nav-4" onclick="goTo(4)">
      <div class="step-icon" id="icon-4">5</div>
      <div><div class="step-label">Launch</div><div class="step-sub">Go live</div></div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">

    <!-- STEP 0: System Check -->
    <div class="section active" id="step-0">
      <h2>System Check</h2>
      <p class="subtitle">Let's verify everything is in place before we configure anything.</p>
      <div class="card">
        <div class="card-title">System Status</div>
        <div id="system-rows">
          <div class="status-row">
            <span class="status-label">Checking system...</span>
            <span><div class="spinner"></div></span>
          </div>
        </div>
      </div>
      <div id="sys-alert" class="alert"></div>
      <div id="install-picoclaw-section">
        <div class="card" style="border-color: var(--warning)">
          <div class="card-title">PicoClaw Not Found</div>
          <p style="font-size:13px; color:var(--text2); margin-bottom:14px">Click below to automatically download and install PicoClaw for your device.</p>
          <div id="install-alert" class="alert"></div>
          <div class="btn-row">
            <button class="btn btn-primary" id="btn-install-picoclaw" onclick="installPicoclaw()">‚¨á Install PicoClaw</button>
          </div>
        </div>
      </div>
      <div id="quick-actions" style="display:none">
        <div class="card">
          <div class="card-title">Quick Actions</div>
          <div id="sys-action-alert" class="alert"></div>
          <div class="action-grid">
            <div class="action-tile" id="tile-restart" onclick="restartServiceFrom('sys-action-alert','tile-restart')">
              <div class="tile-icon">‚Ü∫</div>
              <div class="tile-label">Restart Twin</div>
            </div>
            <div class="action-tile" onclick="goTo(1)">
              <div class="tile-icon">‚öô</div>
              <div class="tile-label">Change Model</div>
            </div>
            <div class="action-tile" id="tile-ping" onclick="pingTelegramFrom('sys-action-alert','tile-ping')">
              <div class="tile-icon">üèì</div>
              <div class="tile-label">Ping Bot</div>
            </div>
          </div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-secondary" onclick="runSystemCheck()">‚Üª Refresh</button>
        <button class="btn btn-primary" id="btn-sys-next" disabled onclick="goTo(1)">Continue ‚Üí</button>
      </div>
    </div>

    <!-- STEP 1: LLM Provider -->
    <div class="section" id="step-1">
      <h2>LLM Provider</h2>
      <p class="subtitle">Choose which AI brain powers your twin. OpenRouter is recommended ‚Äî one key, all models.</p>
      <div class="provider-grid">
        <div class="provider-card selected" onclick="selectProvider('openrouter')" id="pcard-openrouter">
          <div class="provider-name">OpenRouter</div>
          <div class="provider-hint">Recommended ¬∑ All models</div>
        </div>
        <div class="provider-card" onclick="selectProvider('anthropic')" id="pcard-anthropic">
          <div class="provider-name">Anthropic</div>
          <div class="provider-hint">Claude models direct</div>
        </div>
        <div class="provider-card" onclick="selectProvider('gemini')" id="pcard-gemini">
          <div class="provider-name">Gemini</div>
          <div class="provider-hint">Google ¬∑ Free tier</div>
        </div>
        <div class="provider-card" onclick="selectProvider('groq')" id="pcard-groq">
          <div class="provider-name">Groq</div>
          <div class="provider-hint">Very fast ¬∑ Free tier</div>
        </div>
      </div>
      <div class="card">
        <div class="form-group">
          <label>API Key</label>
          <input type="password" id="llm-key" placeholder="Paste your API key here" autocomplete="off" oninput="onKeyInput()" />
          <div class="hint" id="llm-key-hint">Get your free key at <a href="https://openrouter.ai/keys" target="_blank" style="color:var(--accent2)">openrouter.ai/keys</a></div>
          <div class="key-status" id="key-status">‚úì Using saved key ‚Äî paste a new one above to change it</div>
        </div>
        <div class="form-group" id="model-group">
          <label>Model</label>
          <select id="llm-model">
            <option value="">‚Äî paste your key and click Load Models ‚Äî</option>
          </select>
          <div class="model-load-row">
            <button class="btn btn-secondary" id="btn-load-models" onclick="loadModels()" disabled>‚Üª Load Models</button>
            <label><input type="checkbox" id="free-only" onchange="filterModels()" checked /> Free only</label>
          </div>
        </div>
        <div id="llm-alert" class="alert"></div>
        <div class="btn-row">
          <button class="btn btn-primary" id="btn-validate-llm" onclick="validateLLM()">Save Model</button>
          <button class="btn btn-primary" id="btn-llm-next" disabled onclick="goTo(2)">Continue ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- STEP 2: Telegram -->
    <div class="section" id="step-2">
      <h2>Telegram Setup</h2>
      <p class="subtitle">Create a Telegram bot and connect it to your twin. Takes about 3 minutes.</p>
      <div class="card">
        <div class="card-title">Step-by-Step Guide</div>
        <div class="guide-step">
          <div class="guide-num">1</div>
          <div class="guide-text">Open Telegram and search for <code>@BotFather</code> ‚Äî the official bot that creates other bots.</div>
        </div>
        <div class="guide-step">
          <div class="guide-num">2</div>
          <div class="guide-text">Send <code>/newbot</code> and follow BotFather's instructions. Give your bot any name you like.</div>
        </div>
        <div class="guide-step">
          <div class="guide-num">3</div>
          <div class="guide-text">BotFather will give you a token like <code>123456789:ABCdef...</code> ‚Äî paste it below.</div>
        </div>
      </div>
      <div class="card">
        <div class="form-group">
          <label>Bot Token</label>
          <input type="text" id="tg-token" placeholder="123456789:ABCdefGhIjKlmNoPQRsTuVwXyZ" autocomplete="off" autocorrect="off" />
        </div>
        <div id="tg-alert" class="alert"></div>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="validateTelegram()">Validate Token</button>
        </div>
      </div>

      <div id="tg-userid-section" style="display:none">
        <div class="card">
          <div class="card-title">Your Telegram User ID</div>
          <div class="guide-step">
            <div class="guide-num">4</div>
            <div class="guide-text">Search for <code>@userinfobot</code> on Telegram and send it any message. It will reply with your User ID.</div>
          </div>
          <div class="guide-step">
            <div class="guide-num">5</div>
            <div class="guide-text">Open a chat with your new bot and send it <code>/start</code> to activate it.</div>
          </div>
          <div class="form-group" style="margin-top:14px">
            <label>Your Telegram User ID</label>
            <input type="text" id="tg-userid" placeholder="123456789" inputmode="numeric" />
          </div>
          <div id="tg-userid-alert" class="alert"></div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="saveTelegramUser()">Save User ID</button>
          </div>
        </div>
      </div>

      <div id="tg-ping-section" style="display:none">
        <div class="card">
          <div class="card-title">Ping Test</div>
          <p style="font-size:13px; color:var(--text2); margin-bottom:14px">Let's send a real message to verify everything works end-to-end.</p>
          <div id="tg-ping-alert" class="alert"></div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="sendPing()">üèì Send Ping</button>
            <button class="btn btn-primary" id="btn-tg-next" disabled onclick="goTo(3)">Continue ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 3: Soul -->
    <div class="section" id="step-3">
      <h2>Build Your Twin's Soul</h2>
      <p class="subtitle">Answer honestly ‚Äî the more specific you are, the more it sounds like <em>you</em>.</p>
      <div class="card">
        <div class="form-group">
          <label>Your Name</label>
          <input type="text" id="soul-username" placeholder="e.g. Alex" autocomplete="given-name" />
        </div>
        <div class="form-group">
          <label>What should your twin be called?</label>
          <input type="text" id="soul-name" placeholder="e.g. Alex's Twin, Dev Assistant..." />
          <div class="hint">This is your twin's identity name</div>
        </div>
        <div class="form-group">
          <label>What do you do? (role / profession)</label>
          <input type="text" id="soul-role" placeholder="e.g. Software developer, founder, freelancer..." />
        </div>
        <div class="form-group">
          <label>What are you genuinely expert in?</label>
          <textarea id="soul-expertise" placeholder="e.g. Python, FastAPI, React, AWS. I've built SaaS products..."></textarea>
        </div>
        <div class="form-group">
          <label>How do you communicate naturally?</label>
          <textarea id="soul-style" placeholder="e.g. Direct and brief. I give the answer first then explain if needed..."></textarea>
        </div>
        <div class="form-group">
          <label>What do you care most about getting done?</label>
          <textarea id="soul-goals" placeholder="e.g. Shipping things fast, not over-engineering, making money..."></textarea>
        </div>
        <div class="form-group">
          <label>What annoys you / what would you never do?</label>
          <textarea id="soul-dislikes" placeholder="e.g. Wasting time on meetings, over-complicating simple things..."></textarea>
        </div>
        <div class="form-group">
          <label>How do you make decisions when things are unclear?</label>
          <textarea id="soul-decisions" placeholder="e.g. I default to the simpler option. Ship imperfect over waiting for perfect..."></textarea>
        </div>
        <div id="soul-alert" class="alert"></div>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="generateSoul()">‚ú® Generate My SOUL.md</button>
        </div>
      </div>

      <div id="soul-result" style="display:none">
        <div class="card">
          <div class="card-title">Preview ‚Äî Your SOUL.md</div>
          <pre id="soul-preview"></pre>
          <div id="soul-save-alert" class="alert"></div>
          <div class="btn-row">
            <button class="btn btn-secondary" onclick="generateSoul()">‚Üª Regenerate</button>
            <button class="btn btn-primary" onclick="saveSoul()" id="btn-save-soul">Save to Device</button>
            <button class="btn btn-primary" id="btn-soul-next" disabled onclick="goTo(4)">Continue ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 4: Launch -->
    <div class="section" id="step-4">
      <h2>Launch Your Twin üöÄ</h2>
      <p class="subtitle">Everything's configured. Let's get PicoClaw running permanently on your device.</p>
      <div class="card" id="final-checklist">
        <div class="card-title">Final Checklist</div>
        <div id="checklist-rows">
          <div class="status-row"><span>Loading...</span></div>
        </div>
      </div>
      <div class="card" id="service-install-card">
        <p style="font-size:13px; color:var(--text2); margin-bottom:14px" id="service-desc">This sets PicoClaw to start automatically on boot and restart if it crashes.</p>
        <div id="service-alert" class="alert"></div>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="installService()">‚ö° Install &amp; Start Service</button>
        </div>
      </div>

      <div id="launch-success" style="display:none">
        <div class="card" style="border-color: var(--success)">
          <div style="text-align:center; padding: 16px 0">
            <div style="font-size:44px; margin-bottom:10px">üéâ</div>
            <div style="font-size:18px; font-weight:700; margin-bottom:6px">Your twin is live!</div>
            <div style="color:var(--text2); font-size:13px; margin-bottom:16px">Open Telegram and send your bot a message. It will respond as you.</div>
            <div id="action-alert" class="alert" style="text-align:left; margin-bottom:10px"></div>
            <div class="action-grid" style="margin-bottom:16px">
              <div class="action-tile" id="tile-launch-restart" onclick="restartServiceFrom('action-alert','tile-launch-restart')">
                <div class="tile-icon">‚Ü∫</div>
                <div class="tile-label">Restart Twin</div>
              </div>
              <div class="action-tile" onclick="goTo(1)">
                <div class="tile-icon">‚öô</div>
                <div class="tile-label">Change Model</div>
              </div>
              <div class="action-tile" id="tile-launch-ping" onclick="pingTelegramFrom('action-alert','tile-launch-ping')">
                <div class="tile-icon">üèì</div>
                <div class="tile-label">Ping Bot</div>
              </div>
            </div>
            <div class="cmd-block">
              <div class="cmd-hint" id="cmd-hint">Useful commands:</div>
              <code id="cmd-status"></code>
              <code id="cmd-restart"></code>
              <code>picoclaw agent -m "hello"</code>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Mobile Bottom Nav -->
<nav class="bottom-nav" id="bottom-nav">
  <div class="bottom-nav-item active" id="bnav-0" onclick="goTo(0)">
    <div class="bnav-icon" id="bicon-0">1</div>
    <div class="bnav-label">System</div>
  </div>
  <div class="bottom-nav-item" id="bnav-1" onclick="goTo(1)">
    <div class="bnav-icon" id="bicon-1">2</div>
    <div class="bnav-label">LLM</div>
  </div>
  <div class="bottom-nav-item" id="bnav-2" onclick="goTo(2)">
    <div class="bnav-icon" id="bicon-2">3</div>
    <div class="bnav-label">Telegram</div>
  </div>
  <div class="bottom-nav-item" id="bnav-3" onclick="goTo(3)">
    <div class="bnav-icon" id="bicon-3">4</div>
    <div class="bnav-label">Soul</div>
  </div>
  <div class="bottom-nav-item" id="bnav-4" onclick="goTo(4)">
    <div class="bnav-icon" id="bicon-4">5</div>
    <div class="bnav-label">Launch</div>
  </div>
</nav>

<script>
let currentStep = 0;
let selectedProvider = 'openrouter';
let systemData = {};
let state = { system: false, llm: false, telegram: false, soul: false, service: false };
const progress = [10, 30, 55, 75, 95];

const providerModels = {
  openrouter: {
    hint: 'Get your free key at <a href="https://openrouter.ai/keys" target="_blank" style="color:var(--accent2)">openrouter.ai/keys</a>',
    models: [
      ['anthropic/claude-sonnet-4-6', 'Claude Sonnet 4.6 (Recommended)'],
      ['anthropic/claude-haiku-4-5-20251001', 'Claude Haiku 4.5 (Faster/cheaper)'],
      ['google/gemini-flash-1.5', 'Gemini Flash 1.5'],
      ['meta-llama/llama-3.1-8b-instruct:free', 'Llama 3.1 8B (Free)'],
    ]
  },
  anthropic: {
    hint: 'Get your key at <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent2)">console.anthropic.com</a>',
    models: [['claude-sonnet-4-6', 'Claude Sonnet 4.6'], ['claude-haiku-4-5-20251001', 'Claude Haiku 4.5']]
  },
  gemini: {
    hint: 'Get your free key at <a href="https://aistudio.google.com/api-keys" target="_blank" style="color:var(--accent2)">aistudio.google.com</a>',
    models: [['gemini-1.5-flash', 'Gemini 1.5 Flash (Free tier)'], ['gemini-1.5-pro', 'Gemini 1.5 Pro']]
  },
  groq: {
    hint: 'Get your free key at <a href="https://console.groq.com" target="_blank" style="color:var(--accent2)">console.groq.com</a>',
    models: [['llama-3.1-8b-instant', 'Llama 3.1 8B (Fast + Free)'], ['mixtral-8x7b-32768', 'Mixtral 8x7B']]
  }
};

function goTo(n) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.step-item').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.bottom-nav-item').forEach(s => s.classList.remove('active'));
  document.getElementById(`step-${n}`).classList.add('active');
  document.getElementById(`nav-${n}`).classList.add('active');
  document.getElementById(`bnav-${n}`).classList.add('active');
  document.getElementById('progress').style.width = progress[n] + '%';
  currentStep = n;
  document.querySelector('.main').scrollTo({ top: 0, behavior: 'smooth' });
  window.scrollTo({ top: 0, behavior: 'smooth' });
  if (n === 0) runSystemCheck();
  if (n === 1) populateLLM();
  if (n === 2) populateTelegram();
  if (n === 3) populateSoul();
  if (n === 4) loadFinalChecklist();
}

function markDone(n) {
  document.getElementById(`icon-${n}`).textContent = '‚úì';
  document.getElementById(`bicon-${n}`).textContent = '‚úì';
  document.getElementById(`nav-${n}`).classList.add('done');
  document.getElementById(`bnav-${n}`).classList.add('done');
}

function markError(n) {
  document.getElementById(`nav-${n}`).classList.add('error');
  document.getElementById(`bnav-${n}`).classList.add('error');
}

function showAlert(id, type, msg) {
  const el = document.getElementById(id);
  el.className = `alert ${type} visible`;
  el.textContent = msg;
}
function hideAlert(id) { document.getElementById(id).className = 'alert'; }

// Returns true if the current provider has a saved key in config
function hasSavedKey() {
  return systemData.has_provider && systemData.active_provider === selectedProvider;
}

// ‚îÄ‚îÄ Step 0: System Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runSystemCheck() {
  document.getElementById('system-rows').innerHTML = `
    <div class="status-row">
      <span class="status-label">Checking system...</span>
      <span><div class="spinner"></div></span>
    </div>`;

  const r = await fetch('/api/system-check');
  const data = await r.json();
  systemData = data;

  // OS-sensitive labels
  const isMac = data.os === 'mac';
  const deviceLabel = isMac ? 'Mac' : 'Pi';
  document.getElementById('btn-save-soul').textContent = `Save to ${deviceLabel}`;
  document.getElementById('service-desc').textContent = isMac
    ? 'This installs a launchd agent so PicoClaw starts automatically on login and restarts if it crashes.'
    : 'This installs a systemd service so PicoClaw starts automatically on boot and restarts if it crashes.';

  // FIX: check actual value for Disk/RAM ‚Äî 'unavailable' means backend couldn't read it
  const rows = [
    ['PicoClaw',     data.picoclaw_installed,                                   data.picoclaw_version || 'Not found'],
    ['Disk Space',   data.disk_space && data.disk_space !== 'unavailable',       data.disk_space || 'unavailable'],
    ['RAM',          data.ram && data.ram !== 'unavailable',                     data.ram || 'unavailable'],
    ['LLM Provider', data.has_provider, data.active_model ? `${data.active_model} (${data.active_provider})` : 'Not set'],
    ['Telegram',     data.has_telegram, data.telegram_token ? `Token: ${data.telegram_token}` : 'Not set'],
    ['SOUL.md',      data.has_soul,     data.has_soul ? 'Found' : 'Not created'],
    ['Service',      data.service_status === 'active', data.service_status],
  ];

  document.getElementById('system-rows').innerHTML = rows.map(([label, ok, val]) => `
    <div class="status-row">
      <div class="status-left">
        <span class="status-label">${label}</span>
        <span class="status-detail">${val}</span>
      </div>
      <span class="badge ${ok ? 'ok' : ['LLM Provider','Telegram','SOUL.md','Service','Disk Space','RAM'].includes(label) ? 'warn' : 'fail'}">
        ${ok ? '‚úì OK' : '‚óã Pending'}
      </span>
    </div>`).join('');

  if (!data.picoclaw_installed) {
    showAlert('sys-alert', 'error', 'PicoClaw not found on this device.');
    document.getElementById('install-picoclaw-section').style.display = 'block';
    markError(0);
  } else {
    document.getElementById('install-picoclaw-section').style.display = 'none';
    hideAlert('sys-alert');
    document.getElementById('btn-sys-next').disabled = false;
    if (data.checklist.system)   markDone(0);
    if (data.checklist.provider) { markDone(1); state.llm = true; }
    if (data.checklist.telegram) { markDone(2); state.telegram = true; }
    if (data.checklist.soul)     { markDone(3); state.soul = true; }
    if (data.checklist.service)  { markDone(4); state.service = true; }
    state.system = true;
    // Show quick actions on system check if service is running
    const qa = document.getElementById('quick-actions');
    if (qa) qa.style.display = data.service_status === 'active' ? 'block' : 'none';
  }
}

// ‚îÄ‚îÄ Step 1: LLM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectProvider(p) {
  selectedProvider = p;
  document.querySelectorAll('.provider-card').forEach(c => c.classList.remove('selected'));
  document.getElementById(`pcard-${p}`).classList.add('selected');
  const info = providerModels[p];
  document.getElementById('llm-key-hint').innerHTML = info.hint;
  const isOR = p === 'openrouter';
  document.getElementById('btn-load-models').style.display = isOR ? 'inline-flex' : 'none';
  document.getElementById('free-only').parentElement.style.display = isOR ? 'flex' : 'none';
  if (!isOR) {
    document.getElementById('llm-model').innerHTML = info.models
      .map(([v, l]) => `<option value="${v}">${l}</option>`).join('');
  }
  // Don't clear the key field ‚Äî but update the saved-key status indicator
  updateKeyStatus();
}

function updateKeyStatus() {
  const saved = hasSavedKey();
  const keyEl = document.getElementById('key-status');
  keyEl.className = saved ? 'key-status visible' : 'key-status';
  // Enable Load Models if there's a saved key or user typed one
  const typed = document.getElementById('llm-key').value.trim().length >= 10;
  document.getElementById('btn-load-models').disabled = !saved && !typed;
  // Relabel the validate button based on context
  document.getElementById('btn-validate-llm').textContent = saved
    ? 'Save Model'
    : 'Validate Key';
}

function onKeyInput() {
  updateKeyStatus();
}

async function validateLLM() {
  const key = document.getElementById('llm-key').value.trim();
  const model = document.getElementById('llm-model').value;
  if (!model) { showAlert('llm-alert', 'error', 'Please select a model'); return; }

  // Allow empty key only if we have a saved one for this provider
  if (!key && !hasSavedKey()) {
    showAlert('llm-alert', 'error', 'Please enter your API key');
    return;
  }

  const btn = document.getElementById('btn-validate-llm');
  btn.innerHTML = '<div class="spinner"></div> Saving...';
  btn.disabled = true;

  const fd = new FormData();
  fd.append('provider', selectedProvider || 'openrouter');
  fd.append('model', model);
  if (key) fd.append('api_key', key); // only send if user typed one; backend falls back to saved key

  const r = await fetch('/api/validate-llm', { method: 'POST', body: fd });
  const data = await r.json();

  btn.innerHTML = hasSavedKey() ? 'Save Model' : 'Validate Key';
  btn.disabled = false;

  if (data.ok) {
    // Update systemData so hasSavedKey() stays accurate for the new provider
    systemData.has_provider = true;
    systemData.active_provider = selectedProvider;
    systemData.active_model = model;
    updateKeyStatus();
    markDone(1); state.llm = true;
    document.getElementById('btn-llm-next').disabled = false;

    // If service is already running, restart it so the new model takes effect
    if (state.service) {
      showAlert('llm-alert', 'info', `‚úì Model saved ‚Äî restarting agent to apply ${model}...`);
      btn.innerHTML = '<div class="spinner"></div> Restarting...';
      btn.disabled = true;
      const rr = await fetch('/api/restart-service', { method: 'POST' });
      const rd = await rr.json();
      btn.innerHTML = hasSavedKey() ? 'Save Model' : 'Validate Key';
      btn.disabled = false;
      if (rd.ok) {
        showAlert('llm-alert', 'success', `‚úì Model updated & agent restarted ‚Äî now using ${model}`);
      } else {
        showAlert('llm-alert', 'warn', `‚úì Model saved but restart failed: ${rd.message}`);
      }
    } else {
      showAlert('llm-alert', 'success', '‚úì ' + data.message + ` ‚Äî using ${model}`);
    }
  } else {
    showAlert('llm-alert', 'error', '‚úó ' + data.message);
    markError(1);
  }
}

async function loadModels() {
  const key = document.getElementById('llm-key').value.trim();
  const btn = document.getElementById('btn-load-models');
  btn.innerHTML = '<div class="spinner"></div>';
  btn.disabled = true;

  const fd = new FormData();
  fd.append('provider', selectedProvider);
  if (key) fd.append('api_key', key); // omit if empty ‚Äî backend uses saved key

  const r = await fetch('/api/models', { method: 'POST', body: fd });
  const data = await r.json();
  btn.innerHTML = '‚Üª Load Models';
  btn.disabled = false;

  if (!data.ok) { showAlert('llm-alert', 'error', '‚úó ' + data.message); return; }
  allModels = data.models;
  filterModels();
  showAlert('llm-alert', 'success', `‚úì Loaded ${data.models.length} models`);
}

// ‚îÄ‚îÄ Step 2: Telegram ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function validateTelegram() {
  const token = document.getElementById('tg-token').value.trim();
  if (!token) { showAlert('tg-alert', 'error', 'Please enter your bot token'); return; }
  const fd = new FormData(); fd.append('token', token);
  showAlert('tg-alert', 'info', 'Validating token...');
  const r = await fetch('/api/validate-telegram', { method: 'POST', body: fd });
  const data = await r.json();
  if (data.ok) {
    showAlert('tg-alert', 'success', '‚úì ' + data.message);
    document.getElementById('tg-userid-section').style.display = 'block';
  } else { showAlert('tg-alert', 'error', '‚úó ' + data.message); }
}

async function saveTelegramUser() {
  const uid = document.getElementById('tg-userid').value.trim();
  if (!uid) { showAlert('tg-userid-alert', 'error', 'Please enter your User ID'); return; }
  const fd = new FormData(); fd.append('user_id', uid);
  const r = await fetch('/api/save-telegram-user', { method: 'POST', body: fd });
  const data = await r.json();
  if (data.ok) {
    showAlert('tg-userid-alert', 'success', '‚úì User ID saved');
    document.getElementById('tg-ping-section').style.display = 'block';
  }
}

async function sendPing() {
  const uid = document.getElementById('tg-userid').value.trim();
  showAlert('tg-ping-alert', 'info', 'Sending ping...');
  const fd = new FormData(); fd.append('chat_id', uid);
  const r = await fetch('/api/ping-telegram', { method: 'POST', body: fd });
  const data = await r.json();
  if (data.ok) {
    showAlert('tg-ping-alert', 'success', '‚úì Ping sent! Check your Telegram ‚Äî if you got it, continue.');
    document.getElementById('btn-tg-next').disabled = false;
    markDone(2); state.telegram = true;
  } else {
    showAlert('tg-ping-alert', 'error', '‚úó ' + data.message + ' ‚Äî Make sure you sent /start to your bot first.');
  }
}

// ‚îÄ‚îÄ Step 3: Soul ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateSoul() {
  const fields = ['username', 'name', 'role', 'expertise', 'style', 'goals', 'dislikes', 'decisions'];
  for (const f of fields) {
    if (!document.getElementById(`soul-${f}`).value.trim()) {
      showAlert('soul-alert', 'error', `Please fill in all fields ‚Äî "${f}" is empty`);
      return;
    }
  }
  showAlert('soul-alert', 'info', 'Generating your SOUL.md...');
  const fd = new FormData();
  fields.forEach(f => fd.append(f === 'username' ? 'user_name' : f, document.getElementById(`soul-${f}`).value.trim()));
  const r = await fetch('/api/generate-soul', { method: 'POST', body: fd });
  const data = await r.json();
  hideAlert('soul-alert');
  document.getElementById('soul-result').style.display = 'block';
  const preview = document.getElementById('soul-preview');
  preview.textContent = data.soul;
  preview.style.display = 'block';
  preview.dataset.soul = data.soul;
}

async function saveSoul() {
  const soul = document.getElementById('soul-preview').dataset.soul;
  if (!soul) return;
  const fd = new FormData(); fd.append('soul_content', soul);
  const r = await fetch('/api/save-soul', { method: 'POST', body: fd });
  const data = await r.json();
  if (data.ok) {
    showAlert('soul-save-alert', 'success', '‚úì SOUL.md saved to your device at ' + data.message.split('to ')[1]);
    document.getElementById('btn-soul-next').disabled = false;
    markDone(3); state.soul = true;
  } else { showAlert('soul-save-alert', 'error', '‚úó ' + data.message); }
}

// ‚îÄ‚îÄ Step 4: Launch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFinalChecklist() {
  const r = await fetch('/api/system-check');
  const data = await r.json();
  systemData = data; // keep in sync

  const items = [
    ['PicoClaw installed', data.picoclaw_installed],
    ['LLM provider configured', data.has_provider],
    ['Telegram connected', data.has_telegram],
    ['SOUL.md created', data.has_soul],
    ['Service running', data.service_status === 'active'],
  ];
  document.getElementById('checklist-rows').innerHTML = items.map(([label, ok]) => `
    <div class="final-item">
      <span class="check">${ok ? '‚úÖ' : '‚≠ï'}</span>
      <span>${label}</span>
    </div>`).join('');

  if (data.service_status === 'active') {
    document.getElementById('service-install-card').style.display = 'none';
    document.getElementById('launch-success').style.display = 'block';
    document.getElementById('progress').style.width = '100%';
    markDone(4);
    populateOSCommands(data.os === 'mac');
  } else {
    document.getElementById('service-install-card').style.display = 'block';
    document.getElementById('launch-success').style.display = 'none';
  }
}

async function installService() {
  showAlert('service-alert', 'info', 'Installing service...');
  const r = await fetch('/api/install-service', { method: 'POST' });
  const data = await r.json();
  if (data.ok) {
    showAlert('service-alert', 'success', '‚úì ' + data.message);
    markDone(4); state.service = true;
    // Re-fetch system status so checklist shows real service state
    await loadFinalChecklist();
  } else { showAlert('service-alert', 'error', '‚úó ' + data.message); }
}

function populateOSCommands(isMac) {
  document.getElementById('cmd-hint').textContent = isMac ? 'Useful commands on your Mac:' : 'Useful commands on your Pi:';
  document.getElementById('cmd-status').textContent = isMac
    ? 'launchctl list | grep picoclaw'
    : 'systemctl --user status picoclaw';
  document.getElementById('cmd-restart').textContent = isMac
    ? 'launchctl unload ~/Library/LaunchAgents/com.picoclaw.agent.plist && launchctl load ~/Library/LaunchAgents/com.picoclaw.agent.plist'
    : 'systemctl --user restart picoclaw';
}

function populateLLM() {
  if (systemData.active_provider) selectProvider(systemData.active_provider);
  if (systemData.active_model) {
    const sel = document.getElementById('llm-model');
    let found = false;
    for (const opt of sel.options) {
      if (opt.value === systemData.active_model) { opt.selected = true; found = true; break; }
    }
    if (!found) {
      const opt = document.createElement('option');
      opt.value = systemData.active_model;
      opt.text = systemData.active_model + ' (current)';
      opt.selected = true;
      sel.insertBefore(opt, sel.firstChild);
    }
  }
  if (systemData.has_provider) {
    showAlert('llm-alert', 'success', '‚úì Already configured ‚Äî model: ' + systemData.active_model);
    document.getElementById('btn-llm-next').disabled = false;
    markDone(1);
  }
  // Always call this so Load Models button and key-status reflect current state
  updateKeyStatus();
}

function populateTelegram() {
  if (!systemData.has_telegram) return;
  showAlert('tg-alert', 'success', '‚úì Telegram already configured ‚Äî token: ' + systemData.telegram_token);
  document.getElementById('tg-userid-section').style.display = 'block';
  document.getElementById('tg-ping-section').style.display = 'block';
  if (systemData.telegram_user) {
    document.getElementById('tg-userid').value = systemData.telegram_user;
    showAlert('tg-userid-alert', 'success', '‚úì User ID already saved: ' + systemData.telegram_user);
  }
  document.getElementById('btn-tg-next').disabled = false;
  markDone(2);
}

function populateSoul() {
  if (!systemData.has_soul) return;
  showAlert('soul-alert', 'success', '‚úì SOUL.md already exists ‚Äî fill the form and regenerate to update it.');
}

async function installPicoclaw() {
  const btn = document.getElementById('btn-install-picoclaw');
  btn.innerHTML = '<div class="spinner"></div> Installing...';
  btn.disabled = true;
  showAlert('install-alert', 'info', 'Downloading PicoClaw for your device...');
  const r = await fetch('/api/install-picoclaw', { method: 'POST' });
  const data = await r.json();
  if (data.ok) {
    showAlert('install-alert', 'success', '‚úì ' + data.message);
    document.getElementById('install-picoclaw-section').style.display = 'none';
    setTimeout(() => runSystemCheck(), 1000);
  } else {
    showAlert('install-alert', 'error', '‚úó ' + data.message);
    btn.innerHTML = '‚¨á Retry Install';
    btn.disabled = false;
  }
}

async function restartService() { await restartServiceFrom('action-alert', 'tile-launch-restart'); }
async function restartServiceFrom(alertId, tileId) {
  const tile = document.getElementById(tileId);
  const origHTML = tile.innerHTML;
  tile.classList.add('loading');
  tile.querySelector('.tile-icon').textContent = '‚è≥';
  const r = await fetch('/api/restart-service', { method: 'POST' });
  const data = await r.json();
  tile.innerHTML = origHTML;
  tile.classList.remove('loading');
  if (data.ok) {
    showAlert(alertId, 'success', '‚úì Agent restarted');
  } else {
    showAlert(alertId, 'error', '‚úó ' + data.message);
  }
  setTimeout(() => hideAlert(alertId), 4000);
}

async function pingTelegramAction() { await pingTelegramFrom('action-alert', 'tile-launch-ping'); }
async function pingTelegramFrom(alertId, tileId) {
  const tile = document.getElementById(tileId);
  const origHTML = tile.innerHTML;
  tile.classList.add('loading');
  tile.querySelector('.tile-icon').textContent = '‚è≥';
  const chatId = systemData.telegram_user || '';
  if (!chatId) {
    showAlert(alertId, 'error', 'No Telegram user ID saved ‚Äî complete step 3 first');
    tile.innerHTML = origHTML;
    tile.classList.remove('loading');
    return;
  }
  const fd = new FormData(); fd.append('chat_id', chatId);
  const r = await fetch('/api/ping-telegram', { method: 'POST', body: fd });
  const data = await r.json();
  tile.innerHTML = origHTML;
  tile.classList.remove('loading');
  if (data.ok) {
    showAlert(alertId, 'success', '‚úì Ping sent!');
  } else {
    showAlert(alertId, 'error', '‚úó ' + data.message);
  }
  setTimeout(() => hideAlert(alertId), 4000);
}

let allModels = [];

function filterModels() {
  const freeOnly = document.getElementById('free-only').checked;
  const sel = document.getElementById('llm-model');
  const filtered = freeOnly ? allModels.filter(m => m.free) : allModels;
  sel.innerHTML = filtered.map(m => `<option value="${m.id}">${m.name}${m.free ? ' üÜì' : ''}</option>`).join('');
}

// ‚îÄ‚îÄ Network bar & QR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let localIP = '';

async function initNetBar() {
  try {
    const r = await fetch('/api/local-ip');
    const data = await r.json();
    localIP = data.ip || window.location.hostname;
  } catch(e) {
    localIP = window.location.hostname;
  }
  const url = `http://${localIP}:3000`;
  document.getElementById('net-url-text').textContent = url;
  document.getElementById('net-bar').style.display = 'flex';
}

function copyNetUrl() {
  const url = `http://${localIP}:3000`;
  navigator.clipboard.writeText(url).then(() => {
    const btn = document.getElementById('net-copy-btn');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 1800);
  }).catch(() => {
    prompt('Copy this URL:', url);
  });
}

function openQR() {
  const url = `http://${localIP}:3000`;
  document.getElementById('qr-url-label').textContent = url;
  document.getElementById('qr-overlay').classList.add('open');

  const container = document.getElementById('qr-container');
  container.innerHTML = '<div class="spinner"></div>';

  // Use Google Charts QR API ‚Äî reliable, no JS library needed
  const img = new Image();
  img.width = 200;
  img.height = 200;
  img.style.borderRadius = '8px';
  img.style.display = 'block';
  img.alt = url;
  img.onload = () => { container.innerHTML = ''; container.appendChild(img); };
  img.onerror = () => {
    // If no internet, render QR natively using canvas
    container.innerHTML = '';
    renderQRCanvas(container, url);
  };
  img.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&color=ffffff&bgcolor=1a1d27&data=${encodeURIComponent(url)}`;
}

// Pure-JS QR fallback using a tiny Reed-Solomon encoder
// Based on the MIT-licensed nayuki QR algorithm (simplified for URLs)
function renderQRCanvas(container, text) {
  // Use a simple approach: encode as data matrix via inline SVG path
  // For local network URLs, we use a pre-computed approach via fetch trick
  const canvas = document.createElement('canvas');
  canvas.width = 200; canvas.height = 200;
  canvas.style.borderRadius = '8px';
  container.appendChild(canvas);
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#1a1d27';
  ctx.fillRect(0,0,200,200);
  ctx.fillStyle = '#ffffff';
  ctx.font = '11px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('QR needs internet', 100, 90);
  ctx.fillText('to generate.', 100, 108);
  ctx.font = '10px monospace';
  ctx.fillStyle = 'var(--accent2)';
  ctx.fillText('URL copied to clipboard', 100, 135);
  navigator.clipboard.writeText(text).catch(()=>{});
}

function closeQR() {
  document.getElementById('qr-overlay').classList.remove('open');
}

function closeQRIfOutside(e) {
  if (e.target === document.getElementById('qr-overlay')) closeQR();
}

// Init
initNetBar();
runSystemCheck();
</script>
</body>
</html>
